作业 8 刘子扬2020K8009929043

8.1 一台机器虚存采用分段机制，物理内存当前的空闲空间如下(按物理地址由小到大的顺 序):12MB, 5MB, 18MB, 20MB, 8MB, 9MB, 10MB和15MB。此时要为三个段分配空间(按时间 先后顺序): 段A申请12MB，段B申请10MB，段C申请9MB。请分别给出采用Best Fit， Worst Fit，First Fit 和 Next Fit算法下，每次分配成的空闲空间状态(按物理地址由小到大顺序)，以及每次分配所需的比较次数。

1. Best Fit (默认最佳适配算法会搜索整个链表，而不是找到一定最适配的就停下)

起始：
```
    12MB->5MB->18MB->20MB->8MB->9MB->10MB->15MB
```    
段A申请12MB，搜索比较整个链表，找到一个12MB的块，共计8次。
```
    5MB->18MB->20MB->8MB->9MB->10MB->15MB
```
段B申请10MB，搜索比较整个链表，找到一个10MB的块，共计7次。
```
    5MB->18MB->20MB->8MB->9MB->15MB
```
段C申请9MB，搜索比较整个链表，找到一个9MB的块，共计6次。
```
    5MB->18MB->20MB->8MB->15MB
```
如果默认最佳适配算法会搜索整个链表，而不是找到一定最适配的就停下，那么会比较21次。如果认为算法找到一样大的就停下来，那么比较12次。

2. Worst Fit

起始：
```
    12MB->5MB->18MB->20MB->8MB->9MB->10MB->15MB
```    
段A申请12MB，搜索比较整个链表，找到一个20MB的块，共计8次。
```
    12MB->5MB->18MB->8MB->8MB->9MB->10MB->15MB
```    
段B申请10MB，搜索比较整个链表，找到一个18MB的块，共计8次。
```
    12MB->5MB->8MB->8MB->8MB->9MB->10MB->15MB
```    
段C申请9MB，搜索比较整个链表，找到一个15MB的块，共计8次。
```
    12MB->5MB->8MB->8MB->8MB->9MB->10MB->6MB
```    
使用最差匹配算法，一共会比较24次。

3. First Fit

起始：
```
    12MB->5MB->18MB->20MB->8MB->9MB->10MB->15MB
```    
段A申请12MB，比较第一个块，发现12MB恰好可以分配，共计1次。
```
    5MB->18MB->20MB->8MB->9MB->10MB->15MB
```    
段B申请10MB，比较到第二个块，发现18MB可以分配，共计2次。
```
    5MB->8MB->20MB->8MB->9MB->10MB->15MB
```  
段C申请9MB，比较到第三个块，发现20MB可以分配，共计3次。
```
    5MB->8MB->11MB->8MB->9MB->10MB->15MB
```  
使用首次适配算法，一共会比较6次。

4. Next Fit

起始：
```
    12MB->5MB->18MB->20MB->8MB->9MB->10MB->15MB
``` 
段A申请12MB，比较第一个块，发现12MB可以分配，共计1次。此时停在5MB的位置。
```
    5MB->18MB->20MB->8MB->9MB->10MB->15MB
```  
段B申请10MB，比较到第二个块，发现18MB可以分配，共计2次。此时停在分配后产生的8MB上。
```
    5MB->8MB->20MB->8MB->9MB->10MB->15MB
```  
段C申请9MB，比较到第二个块，发现20MB可以分配，共计2次。
```
    5MB->8MB->11MB->8MB->9MB->10MB->15MB
``` 
使用下次分配算法，一共会比较5次。

8.2 假设一台计算机使用32-bit的虚拟地址空间和三级页表，虚地址的划分为 8-bit | 6-bit | 6-bit | 12-bit（注：8 bit对应为第一级页表的地址，以此类推）, 请计算：
（1）该计算机系统的页大小是多少？
（2）该三级页表一共能索引多少个页？
（3）现有一个程序的代码段大小为12KB，数据段为20KB，栈大小为4KB，则在使用上述三级页表时，最少需要占用多少个物理页框？最多会占用多少个物理页框？（注：假设程序各段在地址空间中的布局可以自行决定）
（4）在上述（3）中，假设该计算机使用一级页表进行地址空间管理，则（3）中的程序需要占用多少个物理页框？
注：请写出计算过程。

1. 页大小为$2^{12} B = 4KB$
2. 可以索引$2^8\times 2^6\times 2^6 = 2^{20}$个页面
3. 最少：
    
    栈、数据段、代码段都放在一个三级页表对应的虚拟地址空间内。那么此时只需要3个页表，即一级、二级、三级各一张。而代码段、数据段、栈则紧密的放在一起。一共3+9=12个物理页框。

   最多：
    
    栈、数据段、代码段都分散放在不同的二级页表对应的虚拟地址空间内,且代码段和数据段都按照4KB分散开来，那么此时需要一个一级页表，九个二级页表，九个三级页表。一共19+9=28个物理页框。如果对于代码段、数据段虚拟内存要求连续，那么就是一个一级页表，五个二级页表，五个三级页表，一共11+9=20个物理页框。
4. 一级页表：
    需要$2^{20}\times 4B = 4MB$内存，即$1K$个物理页框。
    合计1033个物理页框。

8.3 假设一台计算机上运行一个进程A，该进程的地址空间大小为4 MB（页大小为4KB）。该计算机使用线性页表记录进程A的虚实映射关系，并且将A的页表都保存在内存中。该计算机CPU的TLB大小为32项，每项4B，一次TLB查询或TLB填充的延迟均为5 ns，请计算：
（1）假设该计算机使用软件处理TLB miss，且操作系统进行一次页表查询的平均延迟为100 ns，如果想让虚实地址映射的平均延迟为40 ns，那么 TLB的命中率应为多少？如果想让虚实地址映射的平均延迟不超过15 ns，那么TLB的命中率应为多少？（上述各项操作的延迟不变）

1. 
访问TLB的行为如下：

TLB查询 5ns

如果TLB miss， 进行一次页表查询 100ns

TLB填充 5ns

TLB再次查询 5ns

$ rate * 5 + (1-rate) * 115 = 40 $ 得命中率为68.18%

$ rate * 5 + (1-rate) * 115 = 15 $ 得命中率为90.91%

8.4 现有如下C程序
```
uint32 X[N];
int step = M, i = 0;
for(i=0;i<N;i+=step) X[i] = X[i] + 1;
```
请计算：
（1）	假设该程序运行在一台计算机上，该计算机的虚址空间为32-bit，物理地址空间为2 GB，页大小为4 KB，如果采用一级页表，则该页表的页表项一共有多少？
（2）	假设该计算机的CPU的TLB大小为32项，每项4B，那么题述程序中的M和N取值为多少时，会使得程序中循环的每一次执行都会触发TLB miss？（假设TLB初始为空）
（3）	在（2）中，M和N取值多少时，会使得程序中的循环执行时TLB hit最多？（假设TLB初始为空）

1. 一级页表，则页表项有$2^{20} = 1M$项。
2. 一个TLB对应一个4KB的页框。uint32为4B，因此$M\ge 2^{10}=1024$时每一次循环都会触发TLB miss，此时N的取值没有限制。
3. 最理想的情况就是只有一次TLB miss，即[X+0,X+(N-1)*step]在一个页框内。
即满足$addr(X)$%$2^{12}+4(N-1)\times M \le 2^{12}$

预想使得命中次数最多，一个比较好的情况是X对4KB对齐且令M=1，N=1024，则可以在miss一次后命中$1023$次。